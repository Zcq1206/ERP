"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_utils=_interopRequireWildcard(require("../../tools/utils")),_util=require("./util"),_dom=_interopRequireDefault(require("../../tools/dom"));function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var l=new WeakMap,t=new WeakMap;return(_getRequireWildcardCache=function(e){return e?t:l})(e)}function _interopRequireWildcard(e,l){if(!l&&e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(l);if(t&&t.has(e))return t.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var i in e)if("default"!==i&&Object.prototype.hasOwnProperty.call(e,i)){var n=o?Object.getOwnPropertyDescriptor(e,i):null;n&&(n.get||n.set)?Object.defineProperty(r,i,n):r[i]=e[i]}return r.default=e,t&&t.set(e,r),r}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,l,t){return l in e?Object.defineProperty(e,l,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[l]=t,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,l){if(e){if("string"==typeof e)return _arrayLikeToArray(e,l);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,l):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,l){(null==l||l>e.length)&&(l=e.length);for(var t=0,r=new Array(l);t<l;t++)r[t]=e[t];return r}var scrollProcessTimeout,renderType="body";function isOperateMouse(e){return e._isResize||e.lastScrollTime&&Date.now()<e.lastScrollTime+e.delayHover}function renderLine(e,l,t,r){var o=r.row,i=r.column,n=t.treeOpts,a=t.treeConfig,s=t.fullAllDataRowIdData,c=i.slots,d=i.treeNode,u=s[(0,_util.getRowid)(t,o)],p=0,f=0,y=[];return u&&(p=u.level,f=u._index,y=u.items),c&&c.line?t.callSlot(c.line,r,e):a&&d&&n.line?[e("div",{class:"vxe-tree--line-wrapper"},[e("div",{class:"vxe-tree--line",style:{height:"".concat((0,_util.calcTreeLine)(r,y,f),"px"),left:"".concat(p*n.indent+(p?2-(0,_util.getOffsetSize)(t):0)+16,"px")}})])]:[]}function renderColumn(e,l,t,r,o,i,n,a,s,c,d,u,p,f,y){var h,v,g=t.$listeners,m=t.afterFullData,w=t.tableData,b=t.height,x=t.columnKey,_=t.overflowX,T=t.sYOpts,S=t.scrollXLoad,O=t.scrollYLoad,C=t.highlightCurrentRow,L=t.showOverflow,$=t.isAllOverflow,R=t.align,k=t.currentColumn,H=t.cellClassName,I=t.cellStyle,E=t.mergeList,A=t.spanMethod,W=t.radioOpts,Y=t.checkboxOpts,P=t.expandOpts,D=t.treeOpts,M=t.tooltipOpts,q=t.mouseConfig,B=t.editConfig,j=t.editOpts,U=t.editRules,X=t.validOpts,N=t.editStore,z=t.validStore,F=t.tooltipConfig,K=t.rowOpts,V=t.columnOpts,G=u.type,J=u.cellRender,Q=u.editRender,Z=u.align,ee=u.showOverflow,le=u.className,te=u.treeNode,re=N.actived,oe=T.rHeight,ie=K.height,ne=M.showAll||M.enabled,ae=t.getColumnIndex(u),se=t.getVTColumnIndex(u),ce=(0,_utils.isEnableConf)(Q),de=i?u.fixed!==i:u.fixed&&_,ue=_xeUtils.default.isUndefined(ee)||_xeUtils.default.isNull(ee)?L:ee,pe="ellipsis"===ue,fe="title"===ue,ye=!0===ue||"tooltip"===ue,he=fe||ye||pe,ve={},ge=Z||R,me=z.row===a&&z.column===u,we=U&&X.showMessage&&("default"===X.message?b||1<w.length:"inline"===X.message),be={colid:u.id},xe=g["cell-mouseenter"],_e=g["cell-mouseleave"],Te=Q&&B&&"dblclick"===j.trigger,Se={$table:t,seq:r,rowid:o,row:a,rowIndex:s,$rowIndex:c,_rowIndex:d,column:u,columnIndex:ae,$columnIndex:p,_columnIndex:se,fixed:i,type:renderType,isHidden:de,level:n,visibleData:m,data:w,items:y};if(!S&&!O||he||(pe=he=!0),(fe||ye||ne||xe||F)&&(ve.mouseenter=function(e){isOperateMouse(t)||(fe?_dom.default.updateCellTitle(e.currentTarget,u):(ye||ne)&&t.triggerBodyTooltipEvent(e,Se),xe&&t.emitEvent("cell-mouseenter",Object.assign({cell:e.currentTarget},Se),e))}),(ye||ne||_e||F)&&(ve.mouseleave=function(e){isOperateMouse(t)||((ye||ne)&&t.handleTargetLeaveEvent(e),_e&&t.emitEvent("cell-mouseleave",Object.assign({cell:e.currentTarget},Se),e))}),(Y.range||q)&&(ve.mousedown=function(e){t.triggerCellMousedownEvent(e,Se)}),(K.isCurrent||C||g["cell-click"]||Q&&B||"row"===P.trigger||"cell"===P.trigger||"row"===W.trigger||"radio"===u.type&&"cell"===W.trigger||"row"===Y.trigger||"checkbox"===u.type&&"cell"===Y.trigger||"row"===D.trigger||u.treeNode&&"cell"===D.trigger)&&(ve.click=function(e){t.triggerCellClickEvent(e,Se)}),(Te||g["cell-dblclick"])&&(ve.dblclick=function(e){t.triggerCellDblclickEvent(e,Se)}),E.length){var Oe=(0,_util.mergeBodyMethod)(E,d,se);if(Oe){var Ce=Oe.rowspan,Le=Oe.colspan;if(!Ce||!Le)return null;1<Ce&&(be.rowspan=Ce),1<Le&&(be.colspan=Le)}}else if(A){var $e=A(Se)||{},Re=$e.rowspan,ke=void 0===Re?1:Re,He=$e.colspan,Ie=void 0===He?1:He;if(!ke||!Ie)return null;1<ke&&(be.rowspan=ke),1<Ie&&(be.colspan=Ie)}de&&E&&(1<be.colspan||1<be.rowspan)&&(de=!1),!de&&B&&(Q||J)&&(j.showStatus||j.showUpdateStatus)&&(v=t.isUpdateByRow(a,u.property));var Ee=[];return de&&(L?$:L)?Ee.push(e("div",{class:["vxe-cell",{"c--title":fe,"c--tooltip":ye,"c--ellipsis":pe}],style:{maxHeight:he&&(oe||ie)?"".concat(oe||ie,"px"):""}})):(Ee.push.apply(Ee,_toConsumableArray(renderLine(e,l,t,Se)).concat([e("div",{class:["vxe-cell",{"c--title":fe,"c--tooltip":ye,"c--ellipsis":pe}],style:{maxHeight:he&&(oe||ie)?"".concat(oe||ie,"px"):""},attrs:{title:fe?t.getCellLabel(a,u):null}},u.renderCell(e,Se))])),we&&me&&Ee.push(e("div",{class:"vxe-cell--valid",style:z.rule&&z.rule.maxWidth?{width:"".concat(z.rule.maxWidth,"px")}:null},[e("span",{class:"vxe-cell--valid-msg"},z.content)]))),e("td",{class:["vxe-body--column",u.id,(h={},_defineProperty(h,"col--".concat(ge),ge),_defineProperty(h,"col--".concat(G),G),_defineProperty(h,"col--last",p===f.length-1),_defineProperty(h,"col--tree-node",te),_defineProperty(h,"col--edit",ce),_defineProperty(h,"col--ellipsis",he),_defineProperty(h,"fixed--hidden",de),_defineProperty(h,"col--dirty",v),_defineProperty(h,"col--actived",B&&ce&&re.row===a&&(re.column===u||"row"===j.mode)),_defineProperty(h,"col--valid-error",me),_defineProperty(h,"col--current",k===u),h),_utils.default.getClass(le,Se),_utils.default.getClass(H,Se)],key:x||V.useKey?u.id:p,attrs:be,style:Object.assign({height:he&&(oe||ie)?"".concat(oe||ie,"px"):""},I?_xeUtils.default.isFunction(I)?I(Se):I:null),on:ve},Ee)}function renderRows(v,g,m,w,b,x){var _=m.stripe,T=m.rowKey,S=m.highlightHoverRow,O=m.rowClassName,C=m.rowStyle,L=m.editConfig,$=m.showOverflow,R=m.treeConfig,k=m.treeOpts,H=m.editOpts,I=m.treeExpandeds,E=m.scrollYLoad,A=m.editStore,W=m.rowExpandeds,Y=m.radioOpts,P=m.checkboxOpts,D=m.expandColumn,M=m.hasFixedColumn,q=m.fullAllDataRowIdData,B=m.rowOpts,j=[];return b.forEach(function(t,r){var o,e={},i=m.getVTRowIndex(t);o=m.getRowIndex(t),(B.isHover||S)&&(e.mouseenter=function(e){isOperateMouse(m)||m.triggerHoverEvent(e,{row:t,rowIndex:o})},e.mouseleave=function(){isOperateMouse(m)||m.clearHoverRow()});var n=(0,_util.getRowid)(m,t),l=q[n],a=l?l.level:0,s=l?l.seq:-1,c={$table:m,seq:s,rowid:n,fixed:w,type:renderType,level:a,row:t,rowIndex:o,$rowIndex:r},d=!1;if(L&&(d=-1<A.insertList.indexOf(t)),j.push(v("tr",{class:["vxe-body--row",{"row--stripe":_&&(m.getVTRowIndex(t)+1)%2==0,"is--new":d,"row--new":d&&(H.showStatus||H.showInsertStatus),"row--radio":Y.highlight&&m.selectRow===t,"row--checked":P.highlight&&m.isCheckedByCheckboxRow(t)},O?_xeUtils.default.isFunction(O)?O(c):O:""],attrs:{rowid:n},style:C?_xeUtils.default.isFunction(C)?C(c):C:null,key:T||B.useKey||R?n:r,on:e},x.map(function(e,l){return renderColumn(v,g,m,s,n,w,a,t,o,r,i,e,l,x,b)}))),D&&W.length&&-1<W.indexOf(t)){var u;R&&(u={paddingLeft:"".concat(a*k.indent+30,"px")});var p=D.showOverflow,f=_xeUtils.default.isUndefined(p)||_xeUtils.default.isNull(p)?$:p,y={$table:m,seq:s,column:D,fixed:w,type:renderType,level:a,row:t,rowIndex:o,$rowIndex:r};j.push(v("tr",{class:"vxe-body--expanded-row",key:"expand_".concat(n),style:C?_xeUtils.default.isFunction(C)?C(y):C:null,on:e},[v("td",{class:["vxe-body--expanded-column",{"fixed--hidden":w&&!M,"col--ellipsis":f}],attrs:{colspan:x.length}},[v("div",{class:"vxe-body--expanded-cell",style:u},[D.renderData(v,y)])])]))}if(R&&!E&&!k.transform&&I.length){var h=t[k.children];h&&h.length&&-1<I.indexOf(t)&&j.push.apply(j,_toConsumableArray(renderRows(v,g,m,w,h,x)))}}),j}function syncBodyScroll(e,l,t,r,o){(r||o)&&(r&&((0,_util.removeScrollListener)(r),r.scrollTop=t),o&&((0,_util.removeScrollListener)(o),o.scrollTop=t),clearTimeout(scrollProcessTimeout),scrollProcessTimeout=setTimeout(function(){(0,_util.restoreScrollListener)(r),(0,_util.restoreScrollListener)(o)},300))}var _default={name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,fixedColumn:Array,size:String,fixedType:String},data:function(){return{wheelTime:null,wheelYSize:0,wheelYInterval:0,wheelYTotal:0}},mounted:function(){var e=this.$parent,l=this.$el,t=this.$refs,r=this.fixedType,o=e.elemStore,i="".concat(r||"main","-body-");o["".concat(i,"wrapper")]=l,o["".concat(i,"table")]=t.table,o["".concat(i,"colgroup")]=t.colgroup,o["".concat(i,"list")]=t.tbody,o["".concat(i,"xSpace")]=t.xSpace,o["".concat(i,"ySpace")]=t.ySpace,o["".concat(i,"emptyBlock")]=t.emptyBlock,this.$el.onscroll=this.scrollEvent,this.$el._onscroll=this.scrollEvent},beforeDestroy:function(){clearTimeout(this.wheelTime),this.$el._onscroll=null,this.$el.onscroll=null},destroyed:function(){var e=this.$parent,l=this.fixedType,t=e.elemStore,r="".concat(l||"main","-body-");t["".concat(r,"wrapper")]=null,t["".concat(r,"table")]=null,t["".concat(r,"colgroup")]=null,t["".concat(r,"list")]=null,t["".concat(r,"xSpace")]=null,t["".concat(r,"ySpace")]=null,t["".concat(r,"emptyBlock")]=null},render:function(t){var e,l=this._e,r=this.$parent,o=this.fixedColumn,i=this.fixedType,n=r.$scopedSlots,a=r.tId,s=r.tableData,c=r.tableColumn,d=r.visibleColumn,u=r.showOverflow,p=r.keyboardConfig,f=r.keyboardOpts,y=r.mergeList,h=r.spanMethod,v=r.scrollXLoad,g=r.scrollYLoad,m=r.isAllOverflow,w=r.emptyOpts,b=r.mouseConfig,x=r.mouseOpts,_=r.sYOpts;if(i&&(c=v||g||(u?m:u)?y.length||h||p&&f.isMerge?d:o:d),n.empty)e=n.empty.call(this,{$table:r},t);else{var T=w.name?_vXETable.default.renderer.get(w.name):null,S=T?T.renderEmpty:null;e=S?S.call(this,t,w,{$table:r}):r.emptyText||_conf.default.i18n("vxe.table.emptyText")}return t("div",{class:["vxe-table--body-wrapper",i?"fixed-".concat(i,"--wrapper"):"body--wrapper"],attrs:{xid:a},on:g&&"wheel"===_.mode?{wheel:this.wheelEvent}:{}},[i?l():t("div",{class:"vxe-body--x-space",ref:"xSpace"}),t("div",{class:"vxe-body--y-space",ref:"ySpace"}),t("table",{class:"vxe-table--body",attrs:{xid:a,cellspacing:0,cellpadding:0,border:0},ref:"table"},[t("colgroup",{ref:"colgroup"},c.map(function(e,l){return t("col",{attrs:{name:e.id},key:l})})),t("tbody",{ref:"tbody"},renderRows(t,this,r,i,s,c))]),t("div",{class:"vxe-table--checkbox-range"}),b&&x.area?t("div",{class:"vxe-table--cell-area"},[t("span",{class:"vxe-table--cell-main-area"},x.extension?[t("span",{class:"vxe-table--cell-main-area-btn",on:{mousedown:function(e){r.triggerCellExtendMousedownEvent(e,{$table:r,fixed:i,type:renderType})}}})]:null),t("span",{class:"vxe-table--cell-copy-area"}),t("span",{class:"vxe-table--cell-extend-area"}),t("span",{class:"vxe-table--cell-multi-area"}),t("span",{class:"vxe-table--cell-active-area"})]):null,i?null:t("div",{class:"vxe-table--empty-block",ref:"emptyBlock"},[t("div",{class:"vxe-table--empty-content"},e)])])},methods:{scrollEvent:function(e){var l=this.$el,t=this.$parent,r=this.fixedType,o=t.$refs,i=t.elemStore,n=t.highlightHoverRow,a=t.scrollXLoad,s=t.scrollYLoad,c=t.lastScrollTop,d=t.lastScrollLeft,u=t.rowOpts,p=o.tableHeader,f=o.tableBody,y=o.leftBody,h=o.rightBody,v=o.tableFooter,g=o.validTip,m=p?p.$el:null,w=v?v.$el:null,b=f.$el,x=y?y.$el:null,_=h?h.$el:null,T=i["main-body-ySpace"],S=i["main-body-xSpace"],O=s&&T?T.clientHeight:b.clientHeight,C=a&&S?S.clientWidth:b.clientWidth,L=l.scrollTop,$=b.scrollLeft,R=$!==d,k=L!==c;t.lastScrollTop=L,t.lastScrollLeft=$,t.lastScrollTime=Date.now(),(u.isHover||n)&&t.clearHoverRow(),x&&"left"===r?syncBodyScroll(t,r,L=x.scrollTop,b,_):_&&"right"===r?syncBodyScroll(t,r,L=_.scrollTop,b,x):(R&&(m&&(m.scrollLeft=b.scrollLeft),w&&(w.scrollLeft=b.scrollLeft)),(x||_)&&(t.checkScrolling(),k&&syncBodyScroll(t,r,L,x,_))),a&&R&&t.triggerScrollXEvent(e),s&&k&&t.triggerScrollYEvent(e),R&&g&&g.visible&&g.updatePlacement(),t.emitEvent("scroll",{type:renderType,fixed:r,scrollTop:L,scrollLeft:$,scrollHeight:b.scrollHeight,scrollWidth:b.scrollWidth,bodyHeight:O,bodyWidth:C,isX:R,isY:k},e)},handleWheel:function(c,d,e,u,p){var f=this,y=this.$parent,l=y.$refs,t=y.elemStore,r=y.scrollYLoad,o=y.scrollXLoad,i=l.tableBody,n=l.leftBody,a=l.rightBody,h=i.$el,v=n?n.$el:null,g=a?a.$el:null,s=this.isPrevWheelTop===d?Math.max(0,this.wheelYSize-this.wheelYTotal):0,m=t["main-body-ySpace"],w=t["main-body-xSpace"],b=r&&m?m.clientHeight:h.clientHeight,x=o&&w?w.clientWidth:h.clientWidth;this.isPrevWheelTop=d,this.wheelYSize=Math.abs(d?e-s:e+s),this.wheelYInterval=0,this.wheelYTotal=0,clearTimeout(this.wheelTime);!function e(){var l=f.fixedType,t=f.wheelYTotal,r=f.wheelYSize,o=f.wheelYInterval;if(t<r){r<(t+=o=Math.max(5,Math.floor(1.5*o)))&&(o-=t-r);var i=h.scrollTop,n=h.clientHeight,a=h.scrollHeight,s=i+o*(d?-1:1);h.scrollTop=s,v&&(v.scrollTop=s),g&&(g.scrollTop=s),(d?s<a-n:0<=s)&&(f.wheelTime=setTimeout(e,10)),f.wheelYTotal=t,f.wheelYInterval=o,y.emitEvent("scroll",{type:renderType,fixed:l,scrollTop:h.scrollTop,scrollLeft:h.scrollLeft,scrollHeight:h.scrollHeight,scrollWidth:h.scrollWidth,bodyHeight:b,bodyWidth:x,isX:u,isY:p},c)}}()},wheelEvent:function(e){var l=e.deltaY,t=e.deltaX,r=this.$el,o=this.$parent,i=o.$refs,n=o.highlightHoverRow,a=o.scrollYLoad,s=o.lastScrollTop,c=o.lastScrollLeft,d=o.rowOpts,u=i.tableBody.$el,p=l,f=t,y=p<0;if(!(y?r.scrollTop<=0:r.scrollTop>=r.scrollHeight-r.clientHeight)){var h=r.scrollTop+p,v=u.scrollLeft+f,g=v!==c,m=h!==s;m&&(e.preventDefault(),o.lastScrollTop=h,o.lastScrollLeft=v,o.lastScrollTime=Date.now(),(d.isHover||n)&&o.clearHoverRow(),this.handleWheel(e,y,p,g,m),a&&o.triggerScrollYEvent(e))}}}};exports.default=_default;