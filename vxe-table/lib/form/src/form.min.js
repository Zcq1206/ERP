"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_size=_interopRequireDefault(require("../../mixins/size")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_utils=require("../../tools/utils"),_dom=_interopRequireWildcard(require("../../tools/dom")),_util=require("./util"),_render=require("./render"),_log=require("../../tools/log");function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,i=new WeakMap;return(_getRequireWildcardCache=function(e){return e?i:t})(e)}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};var i=_getRequireWildcardCache(t);if(i&&i.has(e))return i.get(e);var r={},l=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var n in e)if("default"!==n&&Object.prototype.hasOwnProperty.call(e,n)){var o=l?Object.getOwnPropertyDescriptor(e,n):null;o&&(o.get||o.set)?Object.defineProperty(r,n,o):r[n]=e[n]}return r.default=e,i&&i.set(e,r),r}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}var Rule=function(){function t(e){_classCallCheck(this,t),Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.min,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}return _createClass(t,[{key:"content",get:function(){return(0,_utils.getFuncText)(this.$options.content||this.$options.message)}},{key:"message",get:function(){return this.content}}]),t}();function validErrorRuleValue(e,t){var i=e.type,r=e.min,l=e.max,n=e.pattern,o="number"===i,a=o?_xeUtils.default.toNumber(t):_xeUtils.default.getSize(t);return!(!o||!isNaN(t))||(!_xeUtils.default.eqNull(r)&&a<_xeUtils.default.toNumber(r)||(!_xeUtils.default.eqNull(l)&&a>_xeUtils.default.toNumber(l)||!(!n||(_xeUtils.default.isRegExp(n)?n:new RegExp(n)).test(t))))}function getResetValue(e,t){return _xeUtils.default.isArray(e)&&(t=[]),t}function renderItems(U,q,e){var C=q._e,P=q.rules,N=q.data,V=q.collapseAll,F=q.validOpts,j=q.titleOverflow;return e.map(function(e){var t,i=e.slots,r=e.title,l=e.folding,n=e.visible,o=e.visibleMethod,a=e.field,s=e.collapseNode,u=e.itemRender,c=e.showError,f=e.errRule,d=e.className,m=e.titleOverflow,p=e.children,h=(0,_utils.isEnableConf)(u)?_vXETable.default.renderer.get(u.name):null,v=e.span||q.span,g=e.align||q.align,_=e.titleAlign||q.titleAlign,x=e.titleWidth||q.titleWidth,y=o,b=_xeUtils.default.isUndefined(m)||_xeUtils.default.isNull(m)?j:m,E="title"===b,T=!0===b||"tooltip"===b,R=E||T||"ellipsis"===b,$={data:N,field:a,property:a,item:e,$form:q};if(!1===n)return C();if(p&&0<p.length){var O=renderItems(U,q,e.children);return O.length?U("div",{class:["vxe-form--gather vxe-row",e.id,v?"vxe-col--".concat(v," is--span"):"",d?_xeUtils.default.isFunction(d)?d($):d:""]},O):C()}if(!y&&h&&h.itemVisibleMethod&&(y=h.itemVisibleMethod),P){var w=P[a];w&&(t=w.some(function(e){return e.required}))}var I=[];i&&i.default?I=q.callSlot(i.default,$,U):h&&h.renderItemContent?I=h.renderItemContent.call(q,U,u,$):h&&h.renderItem?I=h.renderItem.call(q,U,u,$):a&&(I=["".concat(_xeUtils.default.get(N,a))]);var S=T?{mouseenter:function(e){q.triggerTitleTipEvent(e,$)},mouseleave:q.handleTitleTipLeaveEvent}:{};return U("div",{class:["vxe-form--item",e.id,v?"vxe-col--".concat(v," is--span"):null,d?_xeUtils.default.isFunction(d)?d($):d:"",{"is--title":r,"is--required":t,"is--hidden":l&&V,"is--active":!y||y($),"is--error":c}],key:e.id},[U("div",{class:"vxe-form--item-inner"},[r||i&&i.title?U("div",{class:["vxe-form--item-title",_?"align--".concat(_):null,{"is--ellipsis":R}],style:x?{width:isNaN(x)?x:"".concat(x,"px")}:null,attrs:{title:E?(0,_utils.getFuncText)(r):null},on:S},(0,_render.renderTitle)(U,q,e)):null,U("div",{class:["vxe-form--item-content",g?"align--".concat(g):null]},I.concat([s?U("div",{class:"vxe-form--item-trigger-node",on:{click:q.toggleCollapseEvent}},[U("span",{class:"vxe-form--item-trigger-text"},V?_conf.default.i18n("vxe.form.unfolding"):_conf.default.i18n("vxe.form.folding")),U("i",{class:["vxe-form--item-trigger-icon",V?_conf.default.icon.FORM_FOLDING:_conf.default.icon.FORM_UNFOLDING]})]):null,f&&F.showMessage?U("div",{class:"vxe-form--item-valid",style:f.maxWidth?{width:"".concat(f.maxWidth,"px")}:null},f.content):null]))])])})}var _default2={name:"VxeForm",mixins:[_size.default],props:{collapseStatus:{type:Boolean,default:!0},loading:Boolean,data:Object,size:{type:String,default:function(){return _conf.default.form.size||_conf.default.size}},span:{type:[String,Number],default:function(){return _conf.default.form.span}},align:{type:String,default:function(){return _conf.default.form.align}},titleAlign:{type:String,default:function(){return _conf.default.form.titleAlign}},titleWidth:{type:[String,Number],default:function(){return _conf.default.form.titleWidth}},titleColon:{type:Boolean,default:function(){return _conf.default.form.titleColon}},titleAsterisk:{type:Boolean,default:function(){return _conf.default.form.titleAsterisk}},titleOverflow:{type:[Boolean,String],default:null},className:[String,Function],items:Array,rules:Object,preventSubmit:{type:Boolean,default:function(){return _conf.default.form.preventSubmit}},validConfig:Object,tooltipConfig:Object,customLayout:{type:Boolean,default:function(){return _conf.default.form.customLayout}}},data:function(){return{collapseAll:this.collapseStatus,staticItems:[],formItems:[],tooltipTimeout:null,tooltipStore:{item:null,visible:!1}}},provide:function(){return{$xeform:this}},computed:{validOpts:function(){return Object.assign({},_conf.default.form.validConfig,this.validConfig)},tooltipOpts:function(){return Object.assign({},_conf.default.tooltip,_conf.default.form.tooltipConfig,this.tooltipConfig)}},watch:{staticItems:function(e){this.formItems=e},items:function(e){this.loadItem(e)},collapseStatus:function(e){this.collapseAll=!!e}},created:function(){var t=this;this.$nextTick(function(){var e=t.items;"development"===process.env.NODE_ENV&&t.customLayout&&t.items&&(0,_log.errLog)("vxe.error.errConflicts",["custom-layout","items"]),e&&t.loadItem(e)})},render:function(e){var t,i=this._e,r=this.loading,l=this.className,n=this.data,o=this.vSize,a=this.tooltipOpts,s=this.formItems,u=this.customLayout,c=_vXETable.default._tooltip;return e("form",{class:["vxe-form",l?_xeUtils.default.isFunction(l)?l({items:s,data:n,$form:this}):l:"",(t={},_defineProperty(t,"size--".concat(o),o),_defineProperty(t,"is--colon",this.titleColon),_defineProperty(t,"is--asterisk",this.titleAsterisk),_defineProperty(t,"is--loading",r),t)],on:{submit:this.submitEvent,reset:this.resetEvent}},[e("div",{class:"vxe-form--wrapper vxe-row"},u?this.$slots.default:renderItems(e,this,s)),e("div",{class:"vxe-form-slots",ref:"hideItem"},u?[]:this.$slots.default),e("div",{class:["vxe-loading",{"is--visible":r}]},[e("div",{class:"vxe-loading--spinner"})]),c?e("vxe-tooltip",{ref:"tooltip",props:a}):i()])},methods:{callSlot:function(e,t,i){if(e){var r=this.$scopedSlots;if(_xeUtils.default.isString(e)&&(e=r[e]||null),_xeUtils.default.isFunction(e))return e.call(this,t,i)}return[]},loadItem:function(e){var t=this;if("development"===process.env.NODE_ENV){var i=this.$scopedSlots;e.forEach(function(e){e.slots&&_xeUtils.default.each(e.slots,function(e){_xeUtils.default.isFunction(e)||i[e]||(0,_log.errLog)("vxe.error.notSlot",[e])})})}return this.staticItems=_xeUtils.default.mapTree(e,function(e){return(0,_util.createItem)(t,e)},{children:"children"}),this.$nextTick()},getItems:function(){var t=[];return _xeUtils.default.eachTree(this.formItems,function(e){t.push(e)},{children:"children"}),t},getItemByField:function(t){var e=_xeUtils.default.findTree(this.formItems,function(e){return e.field===t},{children:"children"});return e?e.item:null},toggleCollapse:function(){var e=!this.collapseAll;return this.collapseAll=e,this.$emit("update:collapseStatus",e),this.$nextTick()},toggleCollapseEvent:function(e){this.toggleCollapse();var t=this.collapseAll;this.$emit("toggle-collapse",{status:t,collapse:t,data:this.data,$form:this,$event:e},e),this.$emit("collapse",{status:t,collapse:t,data:this.data,$form:this,$event:e},e)},submitEvent:function(t){var i=this;t.preventDefault(),this.preventSubmit||(this.clearValidate(),this.beginValidate(this.getItems()).then(function(){i.$emit("submit",{data:i.data,$form:i,$event:t})}).catch(function(e){i.$emit("submit-invalid",{data:i.data,errMap:e,$form:i,$event:t})}))},reset:function(){var n=this,o=this.data;o&&this.getItems().forEach(function(e){var t=e.field,i=e.resetValue,r=e.itemRender;if((0,_utils.isEnableConf)(r)){var l=_vXETable.default.renderer.get(r.name);l&&l.itemResetMethod?l.itemResetMethod({data:o,field:t,property:t,item:e,$form:n}):t&&_xeUtils.default.set(o,t,null===i?getResetValue(_xeUtils.default.get(o,t),void 0):i)}});return this.clearValidate()},resetEvent:function(e){e.preventDefault(),this.reset(),this.$emit("reset",{data:this.data,$form:this,$event:e})},closeTooltip:function(){var e=this.tooltipStore,t=this.$refs.tooltip;return e.visible&&(Object.assign(e,{item:null,visible:!1}),t&&t.close()),this.$nextTick()},triggerTitleTipEvent:function(e,t){var i=t.item,r=this.tooltipStore,l=this.$refs.tooltip,n=e.currentTarget.children[0],o=(n.textContent||"").trim(),a=n.scrollWidth>n.clientWidth;clearTimeout(this.tooltipTimeout),r.item!==i&&this.closeTooltip(),o&&a&&(Object.assign(r,{item:i,visible:!0}),l&&l.open(n,o))},handleTitleTipLeaveEvent:function(){var e=this,t=this.tooltipOpts,i=this.$refs.tooltip;i&&i.setActived(!1),t.enterable?this.tooltipTimeout=setTimeout(function(){(i=e.$refs.tooltip)&&!i.isActived()&&e.closeTooltip()},t.leaveDelay):this.closeTooltip()},clearValidate:function(e){if(e){var t=(0,_util.handleFieldOrItem)(this,e);t&&(t.showError=!1)}else this.getItems().forEach(function(e){e.showError=!1});return this.$nextTick()},validate:function(e){return this.clearValidate(),this.beginValidate(this.getItems(),"",e)},validateField:function(e,t){var i=(0,_util.handleFieldOrItem)(this,e);return this.beginValidate(i?[i]:[],"",t)},beginValidate:function(t,e,i){var n=this,o=this.data,r=this.rules,l=this.validOpts,a={},s=[],u=[];return clearTimeout(this.showErrTime),o&&r?(t.forEach(function(r){var l=r.field;l&&u.push(n.validItemRules(e||"all",l).then(function(){r.errRule=null}).catch(function(e){var t=e.rule,i={rule:t,rules:e.rules,data:o,field:l,property:l,$form:n};return a[l]||(a[l]=[]),a[l].push(i),s.push(l),r.errRule=t,Promise.reject(i)}))}),Promise.all(u).then(function(){i&&i()}).catch(function(){return new Promise(function(e){n.showErrTime=setTimeout(function(){t.forEach(function(e){e.errRule&&(e.showError=!0)})},20),l.autoPos&&n.$nextTick(function(){n.handleFocus(s)}),i?(i(a),e()):e(a)})})):(i&&i(),Promise.resolve())},validItemRules:function(o,a,e){var s=this,u=this.data,t=this.rules,c=[],f=[];if(a&&t){var d=_xeUtils.default.get(t,a);if(d){var m=_xeUtils.default.isUndefined(e)?_xeUtils.default.get(u,a):e;d.forEach(function(t){var e=t.type,i=t.trigger,r=t.required;if("all"===o||!i||o===t.trigger)if(_xeUtils.default.isFunction(t.validator)){var l=t.validator({itemValue:m,rule:t,rules:d,data:u,field:a,property:a,$form:s});l&&(_xeUtils.default.isError(l)?c.push(new Rule({type:"custom",trigger:i,content:l.message,rule:new Rule(t)})):l.catch&&f.push(l.catch(function(e){c.push(new Rule({type:"custom",trigger:i,content:e?e.message:t.content||t.message,rule:new Rule(t)}))})))}else{var n="array"===e?!_xeUtils.default.isArray(m)||!m.length:(0,_utils.eqEmptyValue)(m);(r?n||validErrorRuleValue(t,m):!n&&validErrorRuleValue(t,m))&&c.push(new Rule(t))}})}}return Promise.all(f).then(function(){if(c.length){var e={rules:c,rule:c[0]};return Promise.reject(e)}})},handleFocus:function(e){var a=this,s=this.$el;e.some(function(e,t){var i=a.getItemByField(e);if(i&&(0,_utils.isEnableConf)(i.itemRender)){var r,l=i.itemRender,n=_vXETable.default.renderer.get(l.name);if(t||_dom.default.scrollToView(s.querySelector(".".concat(i.id))),l.autofocus&&(r=s.querySelector(".".concat(i.id," ").concat(l.autofocus))),!r&&n&&n.autofocus&&(r=s.querySelector(".".concat(i.id," ").concat(n.autofocus))),r){if(r.focus(),_dom.browse.msie){var o=r.createTextRange();o.collapse(!1),o.select()}return!0}}})},updateStatus:function(e,t){var r=this,l=e.property;l&&this.validItemRules("change",l,t).then(function(){r.clearValidate(l)}).catch(function(e){var t=e.rule,i=r.getItemByField(l);i&&(i.showError=!0,i.errRule=t)})}}};exports.default=_default2;